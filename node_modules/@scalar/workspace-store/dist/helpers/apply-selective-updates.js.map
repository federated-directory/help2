{
  "version": 3,
  "sources": ["../../src/helpers/apply-selective-updates.ts"],
  "sourcesContent": ["import { type Difference, apply, diff } from '@scalar/json-magic/diff'\n\nimport { type UnknownObject, split } from '@/helpers/general'\n\n/**\n * Checks if a key is a Scalar secret key.\n * Secret keys start with 'x-scalar-secret-' prefix.\n */\nconst isSecretKey = (key: string) => key.startsWith('x-scalar-secret-')\n\n/**\n * Keys to exclude from diffs.\n * These are metadata fields that should be omitted when syncing updates to the original document.\n * Changes to these fields are not persisted.\n */\nconst excludeKeys = new Set(['x-scalar-navigation', 'x-ext', 'x-ext-urls', '$status', 'x-scalar-is-dirty'])\n\n/**\n * Determines whether a diff should be included when applying updates.\n *\n * Returns `true` if the diff does not involve excluded metadata fields\n * (such as navigation or external references) or secret keys.\n * Excluded keys and secret keys are not persisted to the original document.\n */\nconst filterDiff = (diff: Difference<unknown>) => {\n  // Omit diff if its path contains a key we want to exclude from updates\n  if (diff.path.some((p) => excludeKeys.has(p))) {\n    return false\n  }\n\n  // Omit diff if its last path element is a secret key\n  if (isSecretKey(diff.path.at(-1) ?? '')) {\n    return false\n  }\n\n  return true\n}\n\n/**\n * Applies updates from an updated document to an original document, while excluding changes to certain metadata keys.\n *\n * This function computes the differences between the original and updated documents,\n * filters out any diffs that affect excluded keys (such as navigation, external references, or status fields),\n * and applies only the allowed changes to the original document in place.\n *\n * Note: The originalDocument is mutated directly.\n *\n * @param originalDocument - The document to be updated (mutated in place)\n * @param updatedDocument - The document containing the desired changes\n * @returns A tuple: [the updated original document, array of excluded diffs that were not applied]\n */\nexport const applySelectiveUpdates = (originalDocument: UnknownObject, updatedDocument: UnknownObject) => {\n  const diffs: Difference<unknown>[] = diff(originalDocument, updatedDocument)\n\n  const [writableDiffs, excludedDiffs] = split(diffs, filterDiff)\n\n  apply(originalDocument, writableDiffs)\n\n  return excludedDiffs\n}\n"],
  "mappings": "AAAA,SAA0B,OAAO,YAAY;AAE7C,SAA6B,aAAa;AAM1C,MAAM,cAAc,CAAC,QAAgB,IAAI,WAAW,kBAAkB;AAOtE,MAAM,cAAc,oBAAI,IAAI,CAAC,uBAAuB,SAAS,cAAc,WAAW,mBAAmB,CAAC;AAS1G,MAAM,aAAa,CAACA,UAA8B;AAEhD,MAAIA,MAAK,KAAK,KAAK,CAAC,MAAM,YAAY,IAAI,CAAC,CAAC,GAAG;AAC7C,WAAO;AAAA,EACT;AAGA,MAAI,YAAYA,MAAK,KAAK,GAAG,EAAE,KAAK,EAAE,GAAG;AACvC,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAeO,MAAM,wBAAwB,CAAC,kBAAiC,oBAAmC;AACxG,QAAM,QAA+B,KAAK,kBAAkB,eAAe;AAE3E,QAAM,CAAC,eAAe,aAAa,IAAI,MAAM,OAAO,UAAU;AAE9D,QAAM,kBAAkB,aAAa;AAErC,SAAO;AACT;",
  "names": ["diff"]
}
