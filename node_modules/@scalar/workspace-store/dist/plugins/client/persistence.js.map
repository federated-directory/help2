{
  "version": 3,
  "sources": ["../../../src/plugins/client/persistence.ts"],
  "sourcesContent": ["import { debounce } from '@scalar/helpers/general/debounce'\n\nimport { createWorkspaceStorePersistence } from '@/persistence'\nimport type { WorkspacePlugin } from '@/workspace-plugin'\n\n/**\n * Plugin to persist workspace state changes with debounced writes.\n * Each type of change (meta, documentConfigs, documents, etc.) is debounced by key (type + workspaceId + optional documentName).\n * The debounce delay can be customized, defaults to 500ms.\n *\n * This avoids excessive writes to IndexedDB or other persistence layer when changes occur rapidly.\n */\nexport const persistencePlugin = async ({\n  workspaceId,\n  debounceDelay = 500,\n  /** Maximum time in milliseconds to wait before forcing execution, even with continuous calls. */\n  maxWait = 10000,\n}: {\n  workspaceId: string\n  debounceDelay?: number\n  maxWait?: number\n}): Promise<WorkspacePlugin> => {\n  // Create the persistence instance (e.g., IndexedDB, localForage, etc.)\n  const persistence = await createWorkspaceStorePersistence()\n  // Debounced execute function for batching similar state changes\n  const { execute } = debounce({ delay: debounceDelay, maxWait })\n\n  return {\n    hooks: {\n      /**\n       * Handles all workspace state change events.\n       * Each write is debounced by a composite key to prevent frequent writes for the same entity.\n       */\n      onWorkspaceStateChanges(event) {\n        // If the event is for workspace meta data, debounce by workspaceId\n        if (event.type === 'meta') {\n          return execute(`meta-${workspaceId}`, () => persistence.meta.setItem(workspaceId, event.value))\n        }\n\n        // Debounce per document content and workspace\n        if (event.type === 'documents') {\n          return execute(`documents-${workspaceId}-${event.documentName}`, () =>\n            persistence.documents.setItem(workspaceId, event.documentName, event.value),\n          )\n        }\n\n        // Debounce per intermediate document and workspace\n        if (event.type === 'intermediateDocuments') {\n          return execute(`intermediateDocuments-${workspaceId}-${event.documentName}`, () =>\n            persistence.intermediateDocuments.setItem(workspaceId, event.documentName, event.value),\n          )\n        }\n\n        // Debounce per original document and workspace\n        if (event.type === 'originalDocuments') {\n          return execute(`originalDocuments-${workspaceId}-${event.documentName}`, () =>\n            persistence.originalDocuments.setItem(workspaceId, event.documentName, event.value),\n          )\n        }\n\n        // Debounce per document override and workspace\n        if (event.type === 'overrides') {\n          return execute(`overrides-${workspaceId}-${event.documentName}`, () =>\n            persistence.overrides.setItem(workspaceId, event.documentName, event.value),\n          )\n        }\n\n        // Delete document\n        if (event.type === 'deleteDocument') {\n          return execute(`deleteDocument-${workspaceId}-${event.documentName}`, () =>\n            persistence.workspace.deleteDocument(workspaceId, event.documentName),\n          )\n        }\n\n        // No action for other event types\n        return\n      },\n    },\n  }\n}\n"],
  "mappings": "AAAA,SAAS,gBAAgB;AAEzB,SAAS,uCAAuC;AAUzC,MAAM,oBAAoB,OAAO;AAAA,EACtC;AAAA,EACA,gBAAgB;AAAA;AAAA,EAEhB,UAAU;AACZ,MAIgC;AAE9B,QAAM,cAAc,MAAM,gCAAgC;AAE1D,QAAM,EAAE,QAAQ,IAAI,SAAS,EAAE,OAAO,eAAe,QAAQ,CAAC;AAE9D,SAAO;AAAA,IACL,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA,MAKL,wBAAwB,OAAO;AAE7B,YAAI,MAAM,SAAS,QAAQ;AACzB,iBAAO,QAAQ,QAAQ,WAAW,IAAI,MAAM,YAAY,KAAK,QAAQ,aAAa,MAAM,KAAK,CAAC;AAAA,QAChG;AAGA,YAAI,MAAM,SAAS,aAAa;AAC9B,iBAAO;AAAA,YAAQ,aAAa,WAAW,IAAI,MAAM,YAAY;AAAA,YAAI,MAC/D,YAAY,UAAU,QAAQ,aAAa,MAAM,cAAc,MAAM,KAAK;AAAA,UAC5E;AAAA,QACF;AAGA,YAAI,MAAM,SAAS,yBAAyB;AAC1C,iBAAO;AAAA,YAAQ,yBAAyB,WAAW,IAAI,MAAM,YAAY;AAAA,YAAI,MAC3E,YAAY,sBAAsB,QAAQ,aAAa,MAAM,cAAc,MAAM,KAAK;AAAA,UACxF;AAAA,QACF;AAGA,YAAI,MAAM,SAAS,qBAAqB;AACtC,iBAAO;AAAA,YAAQ,qBAAqB,WAAW,IAAI,MAAM,YAAY;AAAA,YAAI,MACvE,YAAY,kBAAkB,QAAQ,aAAa,MAAM,cAAc,MAAM,KAAK;AAAA,UACpF;AAAA,QACF;AAGA,YAAI,MAAM,SAAS,aAAa;AAC9B,iBAAO;AAAA,YAAQ,aAAa,WAAW,IAAI,MAAM,YAAY;AAAA,YAAI,MAC/D,YAAY,UAAU,QAAQ,aAAa,MAAM,cAAc,MAAM,KAAK;AAAA,UAC5E;AAAA,QACF;AAGA,YAAI,MAAM,SAAS,kBAAkB;AACnC,iBAAO;AAAA,YAAQ,kBAAkB,WAAW,IAAI,MAAM,YAAY;AAAA,YAAI,MACpE,YAAY,UAAU,eAAe,aAAa,MAAM,YAAY;AAAA,UACtE;AAAA,QACF;AAGA;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;",
  "names": []
}
