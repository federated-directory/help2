{
  "version": 3,
  "sources": ["../../src/mutators/har-to-operation.ts"],
  "sourcesContent": ["import type { HarRequest } from '@scalar/snippetz'\nimport { getResolvedRef } from '@scalar/workspace-store/helpers/get-resolved-ref'\nimport type { OperationObject, ParameterObject } from '@scalar/workspace-store/schemas/v3.1/strict/openapi-document'\nimport type { ReferenceType } from '@scalar/workspace-store/schemas/v3.1/strict/reference'\n\nimport { isContentTypeParameterObject } from '@/schemas/v3.1/strict/type-guards'\n\ntype HarToOperationProps = {\n  /** HAR request to convert */\n  harRequest: HarRequest\n  /** Name of the example to populate (e.g., 'default', 'example1') */\n  exampleKey: string\n  /** Optional base operation to merge with */\n  baseOperation?: OperationObject\n  /** Optional path variables to merge with */\n  pathVariables?: Record<string, string>\n}\n\nconst preprocessParameters = (\n  parameters: ReferenceType<ParameterObject>[],\n  pathVariables: Record<string, string>,\n  exampleKey: string,\n) => {\n  parameters.forEach((param) => {\n    const resolvedParam = getResolvedRef(param)\n    if (isContentTypeParameterObject(resolvedParam)) {\n      return\n    }\n\n    setParameterDisabled(getResolvedRef(param), exampleKey, true)\n\n    if (resolvedParam.in === 'path') {\n      resolvedParam.examples ||= {}\n      resolvedParam.examples[exampleKey] = {\n        value: pathVariables[resolvedParam.name] ?? '',\n        'x-disabled': false,\n      }\n    }\n  })\n}\n\n/**\n * Converts a HAR request back to an OpenAPI Operation object with populated examples.\n *\n * This function is the reverse of operationToHar - it takes a HAR request and\n * converts it back into an OpenAPI operation structure, populating the example\n * values based on the HAR request data.\n *\n * The conversion handles:\n * - URL parsing to extract path and query parameters\n * - Header extraction and mapping to operation parameters\n * - Query string parsing and mapping to parameters\n * - Cookie extraction and mapping to cookie parameters\n * - Request body extraction and mapping to requestBody with examples\n * - Content-Type detection and media type assignment\n *\n * Note: This function focuses on populating examples and does not reconstruct\n * schema definitions. If you need full schema generation, consider combining\n * this with a schema inference tool.\n *\n * @see https://w3c.github.io/web-performance/specs/HAR/Overview.html\n * @see https://spec.openapis.org/oas/v3.1.0#operation-object\n */\nexport const harToOperation = ({\n  harRequest,\n  exampleKey,\n  baseOperation = {},\n  pathVariables = {},\n}: HarToOperationProps): OperationObject => {\n  // Ensure parameters array exists on the base operation\n  if (!baseOperation.parameters) {\n    baseOperation.parameters = []\n  }\n\n  // Set any other parameters as disabled and set the path variables\n  preprocessParameters(baseOperation.parameters, pathVariables, exampleKey)\n\n  // Process query string parameters from the HAR request\n  if (harRequest.queryString && harRequest.queryString.length > 0) {\n    for (const queryParam of harRequest.queryString) {\n      const param = findOrCreateParameter(baseOperation.parameters, queryParam.name, 'query')\n\n      if (!param || isContentTypeParameterObject(param)) {\n        continue\n      }\n\n      param.examples ||= {}\n      param.examples[exampleKey] = {\n        value: queryParam.value,\n        'x-disabled': false,\n      }\n    }\n  }\n\n  // Process headers from the HAR request\n  if (harRequest.headers && harRequest.headers.length > 0) {\n    for (const header of harRequest.headers) {\n      const param = findOrCreateParameter(baseOperation.parameters, header.name, 'header')\n\n      if (!param || isContentTypeParameterObject(param)) {\n        continue\n      }\n\n      param.examples ||= {}\n      param.examples[exampleKey] = {\n        value: header.value,\n        'x-disabled': false,\n      }\n    }\n  }\n\n  // Process cookies from the HAR request\n  if (harRequest.cookies && harRequest.cookies.length > 0) {\n    for (const cookie of harRequest.cookies) {\n      const param = findOrCreateParameter(baseOperation.parameters, cookie.name, 'cookie')\n\n      if (!param || isContentTypeParameterObject(param)) {\n        continue\n      }\n\n      param.examples ||= {}\n      param.examples[exampleKey] = {\n        value: cookie.value,\n        'x-disabled': false,\n      }\n    }\n  }\n\n  // Process request body from the HAR request\n  if (harRequest.postData) {\n    const { mimeType, text, params } = harRequest.postData\n\n    // Ensure requestBody exists on the base operation\n    if (!baseOperation.requestBody) {\n      baseOperation.requestBody = {\n        content: {},\n      }\n    }\n\n    // Resolve the request body in case it is a reference\n    const requestBody = getResolvedRef(baseOperation.requestBody)\n\n    // Ensure the content type exists in the requestBody\n    if (!requestBody.content[mimeType]) {\n      requestBody.content[mimeType] = {\n        schema: {\n          type: 'object',\n        },\n      }\n    }\n\n    // Get the media type object\n    const mediaType = requestBody.content[mimeType]\n    if (!mediaType) {\n      return baseOperation\n    }\n\n    // Ensure examples object exists\n    mediaType.examples ||= {}\n\n    // Convert the HAR postData to an example value\n    let exampleValue: any\n\n    // If params exist (form data), convert to array\n    if (params && params.length > 0) {\n      exampleValue = []\n      for (const param of params) {\n        exampleValue.push({\n          name: param.name,\n          value: param.value,\n          'x-disabled': false,\n        })\n      }\n    } else {\n      exampleValue = text\n    }\n\n    // Add the example to the media type\n    mediaType.examples[exampleKey] = {\n      value: exampleValue,\n      'x-disabled': false,\n    }\n\n    // Update the selected media type\n    requestBody['x-scalar-selected-content-type'] ||= {}\n    requestBody['x-scalar-selected-content-type'][exampleKey] = mimeType\n  }\n\n  return baseOperation\n}\n\nconst setParameterDisabled = (param: ParameterObject, exampleKey: string, disabled: boolean): void => {\n  if (isContentTypeParameterObject(param)) {\n    return\n  }\n\n  if (!param.examples?.[exampleKey]) {\n    return\n  }\n\n  getResolvedRef(param.examples[exampleKey])['x-disabled'] = disabled\n}\n\n/**\n * Finds an existing parameter in the parameters array or creates a new one.\n * This ensures we do not create duplicate parameters.\n */\nconst findOrCreateParameter = (\n  parameters: ReferenceType<ParameterObject>[],\n  name: string,\n  inValue: 'query' | 'header' | 'path' | 'cookie',\n): ParameterObject => {\n  // Try to find existing parameter using getResolvedRef to handle references\n  for (const param of parameters) {\n    const resolved = getResolvedRef(param)\n    if (isContentTypeParameterObject(resolved)) {\n      continue\n    }\n\n    // Check if parameter location matches\n    if (resolved.in !== inValue) {\n      continue\n    }\n\n    // For headers, use case-insensitive comparison; otherwise use exact match\n    const namesMatch =\n      inValue === 'header' ? resolved.name.toLowerCase() === name.toLowerCase() : resolved.name === name\n\n    if (namesMatch) {\n      return resolved\n    }\n  }\n\n  // Create new parameter with schema\n  const newParam: ParameterObject = {\n    name,\n    in: inValue,\n    schema: {\n      type: 'string',\n    },\n  }\n\n  parameters.push(newParam)\n  return newParam\n}\n"],
  "mappings": "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",
  "names": []
}
