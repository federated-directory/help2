{
  "version": 3,
  "sources": ["../../src/mutators/auth.ts"],
  "sourcesContent": ["import type { AuthEvents } from '@/events/definitions/auth'\nimport { generateUniqueValue } from '@/helpers/generate-unique-value'\nimport { getResolvedRef } from '@/helpers/get-resolved-ref'\nimport { isNonOptionalSecurityRequirement } from '@/helpers/is-non-optional-security-requirement'\nimport { mergeObjects } from '@/helpers/merge-object'\nimport type { WorkspaceDocument } from '@/schemas'\nimport type { SecurityRequirementObject } from '@/schemas/v3.1/strict/security-requirement'\nimport type { OAuth2Object } from '@/schemas/v3.1/strict/security-scheme'\n\n/**\n * Updates the selected security schemes for either the entire document or a specific operation.\n * - Adds newly created security schemes (if any) to the workspace document's components.\n * - Ensures that each new scheme name is unique within the document by using `generateUniqueValue`.\n * - Updates the `x-scalar-selected-security` property on the target (document or operation) to reflect the new set of selected security schemes.\n * - Corrects and maintains the selected index so it points to a valid security scheme.\n *\n * @param document - The workspace OpenAPI document to mutate (can be null, in which case nothing happens)\n * @param selectedSecuritySchemes - The current list of selected security scheme objects\n * @param create - Array of new schemes to create, each with a name and a scheme definition\n * @param meta - Location to update: whole document or a specific operation (`{ type: 'document' }` or `{ type: 'operation', path, method }`)\n *\n * Example usage:\n * ```\n * updateSelectedSecuritySchemes({\n *   document,\n *   selectedSecuritySchemes: [{ bearerAuth: [] }],\n *   create: [\n *     { name: 'ApiKeyAuth', scheme: { type: 'apiKey', in: 'header', name: 'X-API-Key' } }\n *   ],\n *   meta: { type: 'document' }\n * })\n * ```\n */\nexport const updateSelectedSecuritySchemes = async (\n  document: WorkspaceDocument | null,\n  { selectedRequirements, newSchemes, meta }: AuthEvents['auth:update:selected-security-schemes'],\n) => {\n  if (!document) {\n    return\n  }\n\n  // Helper to get the target (whole document or a specific operation)\n  const getTarget = () => {\n    if (meta.type === 'document') {\n      return document\n    }\n\n    return getResolvedRef(document.paths?.[meta.path]?.[meta.method])\n  }\n\n  const createdSecurityRequirements = await Promise.all(\n    newSchemes.map(async (newScheme) => {\n      const uniqueSchemeName = await generateUniqueValue({\n        defaultValue: newScheme.name,\n        validation: (value) => !document.components?.securitySchemes?.[value],\n        maxRetries: 100,\n      })\n\n      if (!uniqueSchemeName) {\n        return\n      }\n\n      // Ensure components and securitySchemes exist\n      if (!document.components) {\n        document.components = {}\n      }\n      if (!document.components.securitySchemes) {\n        document.components.securitySchemes = {}\n      }\n\n      // Add the new security scheme definition\n      document.components.securitySchemes[uniqueSchemeName] = newScheme.scheme\n\n      // Return an OpenAPI Security Requirement Object for this new scheme (empty scope array)\n      return {\n        [uniqueSchemeName]: [],\n      }\n    }),\n  )\n\n  // Create any new security schemes required, ensuring unique names for the components\n  const createdSchemes = createdSecurityRequirements.filter(Boolean) as SecurityRequirementObject[]\n\n  const target = getTarget()\n\n  const newSelectedSecuritySchemes = [...selectedRequirements, ...createdSchemes]\n\n  // If the target (document/operation) doesn't exist, do nothing\n  if (!target) {\n    return\n  }\n\n  // Ensure the x-scalar-selected-security structure exists on the target\n  if (!target['x-scalar-selected-security']) {\n    target['x-scalar-selected-security'] = {\n      selectedIndex: -1,\n      selectedSchemes: [],\n    }\n  }\n\n  const selectedIndex = target['x-scalar-selected-security'].selectedIndex\n\n  // Update the schemes array\n  target['x-scalar-selected-security'].selectedSchemes = newSelectedSecuritySchemes\n\n  // Adjust selected index if there are schemes and the index is unset/invalid\n  if (newSelectedSecuritySchemes.length > 0 && selectedIndex < 0) {\n    target['x-scalar-selected-security'].selectedIndex = 0\n  }\n\n  // If the selected index is now out of bounds, select the last available\n  if (selectedIndex >= newSelectedSecuritySchemes.length) {\n    target['x-scalar-selected-security'].selectedIndex = newSelectedSecuritySchemes.length - 1\n  }\n}\n\n/**\n * Updates a security scheme in the OpenAPI document's components object.\n * Handles updates for HTTP, API Key, and OAuth2 types, saving secret information and configuration for UI-auth flows.\n *\n * @param document - The OpenAPI workspace document (can be null)\n * @param data - The update information, including type and payload\n * @param name - The name of the security scheme in document.components.securitySchemes\n *\n * Example usage:\n *\n * updateSecurityScheme({\n *   document,\n *   data: {\n *     type: 'http',\n *     payload: {\n *       username: 'user123',\n *       password: 'pw123',\n *       token: 'tokenval'\n *     }\n *   },\n *   name: 'MyHttpAuth',\n * })\n */\nexport const updateSecurityScheme = (\n  document: WorkspaceDocument | null,\n  { payload, name }: AuthEvents['auth:update:security-scheme'],\n) => {\n  const target = getResolvedRef(document?.components?.securitySchemes?.[name])\n  if (!target) {\n    console.error(`Security scheme ${name} not found`)\n    return\n  }\n\n  // Handle HTTP (basic, bearer, etc.)\n  if (target.type === payload.type) {\n    mergeObjects(target, payload)\n  }\n\n  return target\n}\n\n/**\n * Sets the selected authentication tab (scheme) index for the given OpenAPI document or operation.\n * - When on the document level, updates the 'selectedIndex' on the document's x-scalar-selected-security extension.\n * - When on an operation (endpoint) level, updates the 'selectedIndex' for that operation's x-scalar-selected-security.\n *\n * Also initializes the x-scalar-selected-security extension if it does not exist.\n *\n * @param document The OpenAPI document object (may be null)\n * @param index The index to set as selected\n * @param meta Context where the selection applies ('document' or specific operation)\n *\n * @example\n * // Document-level tab selection\n * updateSelectedAuthTab({\n *   document,\n *   index: 1,\n *   meta: { type: 'document' }\n * });\n *\n * // Operation-level tab selection (e.g., GET /pets)\n * updateSelectedAuthTab({\n *   document,\n *   index: 0,\n *   meta: { type: 'operation', path: '/pets', method: 'get' }\n * });\n */\nexport const updateSelectedAuthTab = (\n  document: WorkspaceDocument | null,\n  { index, meta }: AuthEvents['auth:update:active-index'],\n) => {\n  if (!document) {\n    return\n  }\n\n  // Determine the target object for setting the auth tab index:\n  // - Document/root level\n  // - Operation/endpoint level (if meta specifies operation)\n  const getTarget = () => {\n    if (meta.type === 'document') {\n      return document\n    }\n    return getResolvedRef(document.paths?.[meta.path]?.[meta.method])\n  }\n\n  const target = getTarget()\n  if (!target) {\n    return\n  }\n\n  // Ensure the 'x-scalar-selected-security' extension exists\n  if (!target['x-scalar-selected-security']) {\n    target['x-scalar-selected-security'] = {\n      selectedIndex: 0,\n      selectedSchemes: [],\n    }\n  }\n\n  // Set the selected auth tab index\n  target['x-scalar-selected-security'].selectedIndex = index\n}\n\n/**\n * Updates the scopes for a specific security requirement in the selected security schemes of\n * a document or operation. Also allow to add a new scope to the scheme.\n *\n * @param document - The OpenAPI WorkspaceDocument to update.\n * @param id - An array of scheme names that uniquely identifies the target security requirement.\n *             For example: ['OAuth', 'ApiKeyAuth']\n * @param name - The security scheme name to update scopes for (e.g., 'OAuth').\n * @param scopes - The new list of scopes to set. For example: ['read:pets', 'write:pets']\n * @param newScopePayload - The payload to add a new scope with\n * @param meta - The context specifying whether the update is at the document-level or operation-level.\n *\n * Example usage:\n * ```ts\n * // Suppose your document (or operation) x-scalar-selected-security looks like:\n * // \"x-scalar-selected-security\": {\n * //   selectedIndex: 0,\n * //   selectedSchemes: [\n * //     { \"OAuth\": [\"read:pets\"] },\n * //     { \"ApiKeyAuth\": [] }\n * //   ]\n * // }\n *\n * updateSelectedScopes({\n *   document,\n *   id: [\"OAuth\"],     // identifies the scheme object: { \"OAuth\": [...] }\n *   name: \"OAuth\",     // scheme name to update within this security requirement\n *   scopes: [\"write:pets\"], // new scopes array\n *   meta: { type: \"document\" }\n * })\n * // After, the first scheme becomes: { \"OAuth\": [\"write:pets\"] }\n * ```\n */\nexport const updateSelectedScopes = (\n  document: WorkspaceDocument | null,\n  { id, name, scopes, newScopePayload, meta }: AuthEvents['auth:update:selected-scopes'],\n) => {\n  if (!document) {\n    return\n  }\n\n  // Determine the target object (document or the operation)\n  const getTarget = () => {\n    if (meta.type === 'document') {\n      return document\n    }\n    return getResolvedRef(document.paths?.[meta.path]?.[meta.method])\n  }\n\n  const target = getTarget()\n  if (!target) {\n    return\n  }\n\n  // Array of security requirement objects under x-scalar-selected-security\n  const selectedSchemes = target['x-scalar-selected-security']?.selectedSchemes\n  if (!selectedSchemes) {\n    return\n  }\n\n  // Find the security requirement that matches the given id (scheme key names)\n  // For example: if id = [\"OAuth\"], matches { OAuth: [...] }\n  const scheme = selectedSchemes.find((scheme) => JSON.stringify(Object.keys(scheme)) === JSON.stringify(id))\n\n  // If the scheme is optional, do nothing as it cannot have scopes\n  if (!isNonOptionalSecurityRequirement(scheme)) {\n    return\n  }\n\n  // If we have a new scope payload, add it to the scheme\n  if (newScopePayload) {\n    const securityScheme = getResolvedRef(document.components?.securitySchemes?.[name])\n    const flow = (securityScheme as OAuth2Object)?.flows?.[newScopePayload?.flowType]\n    if (!flow) {\n      return\n    }\n    flow.scopes ||= {}\n\n    flow.scopes[newScopePayload.name] = newScopePayload.description\n    scheme[name] = [...scopes, newScopePayload.name]\n    return\n  }\n\n  // Set the scopes array for the named security scheme within the found security requirement\n  scheme[name] = scopes\n}\n\n/**\n * Deletes one or more security schemes from an OpenAPI WorkspaceDocument,\n * and removes all references to those schemes from selected security, document-level security,\n * and operation-level security/selected security (e.g., on paths).\n *\n * Example usage:\n *\n * ```ts\n * deleteSecurityScheme({\n *   document,                                // The OpenAPI document to update\n *   names: ['ApiKeyAuth', 'BearerAuth'],     // The names of security schemes you want to delete\n * });\n * ```\n *\n * After running this function:\n * - The named security schemes are removed from the components.securitySchemes section.\n * - All document-level and operation-level security entries referencing those schemes are removed.\n * - Any extended x-scalar-selected-security references to those schemes are also removed.\n */\nexport const deleteSecurityScheme = (\n  document: WorkspaceDocument | null,\n  { names }: AuthEvents['auth:delete:security-scheme'],\n) => {\n  if (!document) {\n    // Early exit if there is no document to modify\n    return\n  }\n\n  // Get the mutable reference to securitySchemes in components (may be a proxy/resolved reference)\n  const target = getResolvedRef(document.components?.securitySchemes)\n\n  if (!target) {\n    // If there are no security schemes to delete from, return early\n    return\n  }\n\n  // Remove each named security scheme from the components.securitySchemes object\n  names.forEach((name) => {\n    delete target[name]\n  })\n\n  // Function to remove any security requirement objects that reference given scheme names.\n  const filterSecuritySchemes = (schemes: SecurityRequirementObject[]) => {\n    // Remove schemes whose key is included in the `names` to be deleted.\n    return schemes.filter((scheme) => !names.some((name) => Object.keys(scheme).includes(name)))\n  }\n\n  // -- Remove from document-level `x-scalar-selected-security` extension, if present\n  if (document['x-scalar-selected-security']) {\n    const selectedSecurity = document['x-scalar-selected-security']\n    selectedSecurity.selectedSchemes = filterSecuritySchemes(selectedSecurity.selectedSchemes)\n  }\n\n  // -- Remove from document-level `security` property, if present\n  if (document['security']) {\n    document['security'] = filterSecuritySchemes(document['security'])\n  }\n\n  // -- For each path and operation, remove deleted security schemes from operation-level security and custom extension\n  Object.values(document.paths ?? {}).forEach((path) => {\n    Object.values(path).forEach((operation) => {\n      if (typeof operation !== 'object') {\n        // Ignore operations that are not objects (could be undefined)\n        return\n      }\n\n      // Get mutable reference for the operation (could resolve $ref proxies)\n      const resolvedOperation = getResolvedRef(operation)\n\n      // Remove from operation-level security array\n      if ('security' in resolvedOperation && resolvedOperation['security']) {\n        resolvedOperation['security'] = filterSecuritySchemes(resolvedOperation['security'])\n      }\n\n      // Remove from operation-level x-scalar-selected-security array\n      if ('x-scalar-selected-security' in resolvedOperation && resolvedOperation['x-scalar-selected-security']) {\n        resolvedOperation['x-scalar-selected-security'].selectedSchemes = filterSecuritySchemes(\n          resolvedOperation['x-scalar-selected-security'].selectedSchemes,\n        )\n      }\n    })\n  })\n}\n\nexport const authMutatorsFactory = ({ document }: { document: WorkspaceDocument | null }) => {\n  return {\n    updateSelectedSecuritySchemes: (payload: AuthEvents['auth:update:selected-security-schemes']) =>\n      updateSelectedSecuritySchemes(document, payload),\n    updateSecurityScheme: (payload: AuthEvents['auth:update:security-scheme']) =>\n      updateSecurityScheme(document, payload),\n    updateSelectedAuthTab: (payload: AuthEvents['auth:update:active-index']) =>\n      updateSelectedAuthTab(document, payload),\n    updateSelectedScopes: (payload: AuthEvents['auth:update:selected-scopes']) =>\n      updateSelectedScopes(document, payload),\n    deleteSecurityScheme: (payload: AuthEvents['auth:delete:security-scheme']) =>\n      deleteSecurityScheme(document, payload),\n  }\n}\n"],
  "mappings": "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",
  "names": ["scheme"]
}
