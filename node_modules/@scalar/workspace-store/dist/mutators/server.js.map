{
  "version": 3,
  "sources": ["../../src/mutators/server.ts"],
  "sourcesContent": ["import { findVariables } from '@scalar/helpers/regex/find-variables'\n\nimport type { ServerEvents } from '@/events/definitions/server'\nimport { coerceValue } from '@/schemas/typebox-coerce'\nimport { type ServerObject, ServerObjectSchema } from '@/schemas/v3.1/strict/openapi-document'\nimport type { WorkspaceDocument } from '@/schemas/workspace'\n\n/**\n * Adds a new ServerObject to the document.\n *\n * @param document - The document to add the server to\n * @returns the new server object or undefined if the document is not found\n */\nexport const addServer = (document: WorkspaceDocument | null): ServerObject | undefined => {\n  if (!document) {\n    return undefined\n  }\n\n  const parsed = coerceValue(ServerObjectSchema, {})\n\n  // Initialize the servers array if it doesn't exist\n  if (!document.servers) {\n    document.servers = []\n  }\n\n  document.servers.push(parsed)\n  return parsed\n}\n\n/**\n * Creates a map of variable names to their character positions in a URL.\n * Used to detect renamed variables by position matching.\n */\nconst getVariablePositions = (url: string, variables: readonly string[]): Record<string, number> => {\n  const positions: Record<string, number> = {}\n\n  for (const varName of variables) {\n    const position = url.indexOf(`{${varName}}`)\n    if (position !== -1) {\n      positions[varName] = position\n    }\n  }\n\n  return positions\n}\n\ntype VariableConfig = {\n  description?: string\n  default?: string\n  enum?: string[]\n}\n\n/**\n * Syncs server variables when the URL changes.\n *\n * Preserves variable configurations by:\n * 1. Keeping variables with matching names\n * 2. Renaming variables at the same position\n * 3. Creating new variables with empty defaults\n */\nconst syncVariablesForUrlChange = (\n  newUrl: string,\n  oldUrl: string,\n  existingVariables: Record<string, VariableConfig>,\n): Record<string, VariableConfig> => {\n  // Filter out undefined values from findVariables results\n  const oldVariables = findVariables(oldUrl, { includePath: true, includeEnv: false }).filter(\n    (v): v is string => v !== undefined,\n  )\n  const newVariables = findVariables(newUrl, { includePath: true, includeEnv: false }).filter(\n    (v): v is string => v !== undefined,\n  )\n\n  const oldPositions = getVariablePositions(oldUrl, oldVariables)\n  const newPositions = getVariablePositions(newUrl, newVariables)\n\n  const usedOldVariables = new Set<string>()\n  const syncedVariables: Record<string, VariableConfig> = {}\n\n  for (const newVar of newVariables) {\n    // Case 1: Variable with same name exists - preserve its config\n    if (existingVariables[newVar]) {\n      syncedVariables[newVar] = existingVariables[newVar]\n      usedOldVariables.add(newVar)\n      continue\n    }\n\n    // Case 2: Check for variable at same position (likely a rename)\n    const newVarPosition = newPositions[newVar]\n    const oldVarAtPosition = oldVariables.find(\n      (oldVar) => oldPositions[oldVar] === newVarPosition && !usedOldVariables.has(oldVar),\n    )\n\n    if (oldVarAtPosition && existingVariables[oldVarAtPosition]) {\n      // Rename: transfer the old variable's config to the new name\n      syncedVariables[newVar] = existingVariables[oldVarAtPosition]\n      usedOldVariables.add(oldVarAtPosition)\n      continue\n    }\n\n    // Case 3: New variable - create with empty default\n    syncedVariables[newVar] = { default: '' }\n  }\n\n  return syncedVariables\n}\n\n/**\n * Updates a ServerObject in the document.\n * When the URL changes, intelligently syncs variables by preserving configurations\n * for renamed variables (detected by position) and existing variables.\n *\n * @param document - The document containing the server to update\n * @param index - The index of the server to update\n * @param server - The partial server object with fields to update\n * @returns the updated server object or undefined if the server is not found\n */\nexport const updateServer = (\n  document: WorkspaceDocument | null,\n  { index, server }: ServerEvents['server:update:server'],\n): ServerObject | undefined => {\n  const oldServer = document?.servers?.[index]\n\n  if (!oldServer) {\n    console.error('Server not found at index:', index)\n    return undefined\n  }\n\n  const oldUrl = oldServer.url\n  const updatedServer = coerceValue(ServerObjectSchema, { ...oldServer, ...server })\n\n  // Sync variables if the URL changed\n  const hasUrlChanged = oldUrl && oldUrl !== updatedServer.url\n  if (hasUrlChanged) {\n    const existingVariables = updatedServer.variables ?? {}\n    updatedServer.variables = syncVariablesForUrlChange(updatedServer.url, oldUrl, existingVariables)\n\n    // If the selected server is the one being updated, set the selected server to the new server\n    if (document['x-scalar-selected-server'] === oldUrl) {\n      document['x-scalar-selected-server'] = updatedServer.url\n    }\n  }\n\n  // Ensure servers array exists and update the server at the specified index\n  if (!document.servers) {\n    document.servers = [updatedServer]\n  } else {\n    document.servers[index] = updatedServer\n  }\n\n  return updatedServer\n}\n\n/**\n * Deletes a ServerObject at the specified index from the target array.\n *\n * @param document - The document to delete the server from\n * @param index - The index of the server to delete.\n */\nexport const deleteServer = (document: WorkspaceDocument | null, { index }: ServerEvents['server:delete:server']) => {\n  if (!document?.servers) {\n    return\n  }\n\n  const url = document.servers[index]?.url\n  document.servers.splice(index, 1)\n\n  // If the selected server is the one being deleted, set the selected server to the first one after removal\n  if (document['x-scalar-selected-server'] === url) {\n    document['x-scalar-selected-server'] = document.servers[0]?.url ?? undefined\n  }\n}\n\n/**\n * Updates a server variable for the selected server\n *\n * @param document - The document to update the server variables in\n * @param index - The index of the server to update\n * @param key - The key of the variable to update\n * @param value - The new value of the variable\n * @returns the updated variable or undefined if the variable is not found\n */\nexport const updateServerVariables = (\n  document: WorkspaceDocument | null,\n  { index, key, value }: ServerEvents['server:update:variables'],\n) => {\n  const variable = document?.servers?.[index]?.variables?.[key]\n  if (!variable) {\n    console.error('Variable not found', key, index)\n    return\n  }\n\n  variable.default = value\n\n  // Now we need to make the url reflect the new variable value\n  const url = document?.servers?.[index]?.url\n  if (!url) {\n    console.error('URL not found', index)\n    return\n  }\n\n  return variable\n}\n\n/**\n * Updates the selected server for the document\n *\n * @param document - The document to update the selected server in\n * @param index - The index of the server to update\n * @returns the url of the selected server or undefined if the server is not found\n */\nexport const updateSelectedServer = (\n  document: WorkspaceDocument | null,\n  { url }: ServerEvents['server:update:selected'],\n): string | undefined => {\n  if (!document) {\n    return\n  }\n\n  // We are explicitly de-selecting the server\n  if (url === '') {\n    document['x-scalar-selected-server'] = ''\n    return ''\n  }\n\n  // If no servers match then return undefined\n  if (!document.servers?.some((server) => server.url === url)) {\n    return\n  }\n\n  /**\n   * [un]set it and return the url,\n   * we specifically use en empty string to indicate that the user has unset the selected server\n   */\n  document['x-scalar-selected-server'] = document['x-scalar-selected-server'] === url ? '' : url\n  return document['x-scalar-selected-server']\n}\n\nexport const serverMutatorsFactory = ({ document }: { document: WorkspaceDocument | null }) => {\n  return {\n    addServer: () => addServer(document),\n    updateServer: (payload: ServerEvents['server:update:server']) => updateServer(document, payload),\n    deleteServer: (payload: ServerEvents['server:delete:server']) => deleteServer(document, payload),\n    updateServerVariables: (payload: ServerEvents['server:update:variables']) =>\n      updateServerVariables(document, payload),\n    updateSelectedServer: (payload: ServerEvents['server:update:selected']) => updateSelectedServer(document, payload),\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
