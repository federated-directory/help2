import r from"ajv-draft-04";import i from"ajv-formats";import s from"ajv/dist/2020.js";import{OpenApiVersions as t,ERRORS as o,OpenApiSpecifications as e}from"../../configuration/index.js";import{details as a}from"../../utils/details.js";import{resolveReferences as n}from"../../utils/resolveReferences.js";import{transformErrors as c}from"../../utils/transformErrors.js";const f={"http://json-schema.org/draft-04/schema#":r,"https://json-schema.org/draft/2020-12/schema":s};class p{version;static supportedVersions=t;ajvValidators={};errors;specificationVersion;specificationType;specification;async validate(r,i){const s=r.find((r=>r.isEntrypoint)),t=s?.specification;this.specification=t,this.specification?.info&&!this.specification.info.version&&(this.specification.info.version="0.0.1");try{if(null==t){if(i?.throwOnError)throw new Error(o.EMPTY_OR_INVALID);return{valid:!1,errors:c(s,o.EMPTY_OR_INVALID)}}const{version:e,specificationType:f,specificationVersion:p}=a(t);if(this.version=e,this.specificationVersion=p,this.specificationType=f,!e)return{valid:!1,errors:c(s,o.OPENAPI_VERSION_NOT_SUPPORTED)};const m=await this.getAjvValidator(e),h=m(t);if(m.errors&&m.errors.length>0)return{valid:!1,errors:c(s,m.errors)};const d=n(r,i);return{valid:h&&d.valid,errors:[...h.errors??[],...d.errors],schema:d.schema}}catch(r){if(i?.throwOnError)throw r;return{valid:!1,errors:c(s,r.message??r)}}}async getAjvValidator(r){if(this.ajvValidators[r])return this.ajvValidators[r];const s=e[r],t=new(0,f[s.$schema])({strict:!1});return i(t),"3.1"===r&&t.addFormat("media-range",!0),this.ajvValidators[r]=t.compile(s)}}export{p as Validator,f as jsonSchemaVersions};
