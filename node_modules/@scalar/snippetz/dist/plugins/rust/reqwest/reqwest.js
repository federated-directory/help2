import { buildQueryString, buildUrl, normalizeRequest, processHeaders } from "../../../libs/http.js";
import { createChain, formatJson, indent, wrapInDoubleQuotes } from "../../../libs/rust.js";
const rustReqwest = {
  target: "rust",
  client: "reqwest",
  title: "reqwest",
  generate(request, options) {
    if (!request) {
      return "";
    }
    const normalizedRequest = normalizeRequest(request);
    const queryString = buildQueryString(normalizedRequest.queryString);
    const url = buildUrl(normalizedRequest.url || "", queryString);
    const headers = processHeaders(normalizedRequest);
    const chainedCalls = [];
    const authCall = createAuthCall(options?.auth);
    if (authCall) {
      chainedCalls.push(authCall);
    }
    chainedCalls.push(...createHeaderCalls(headers));
    const bodyCall = createBodyCall(normalizedRequest.postData);
    if (bodyCall) {
      chainedCalls.push(bodyCall);
    }
    return buildRustCode(url, normalizedRequest.method, chainedCalls);
  }
};
const createMultipartPart = (param) => {
  if (param.fileName) {
    return [
      indent(2, `let part = reqwest::multipart::Part::text(${wrapInDoubleQuotes(param.value || "")})`),
      indent(3, `.file_name(${wrapInDoubleQuotes(param.fileName)});`),
      indent(2, `form = form.part(${wrapInDoubleQuotes(param.name)}, part);`)
    ].join("\n");
  }
  return indent(2, `form = form.text(${wrapInDoubleQuotes(param.name)}, ${wrapInDoubleQuotes(param.value || "")});`);
};
const createAuthCall = (auth) => {
  if (!auth?.username || !auth?.password) {
    return null;
  }
  return createChain("basic_auth", wrapInDoubleQuotes(auth.username), wrapInDoubleQuotes(auth.password));
};
const createHeaderCalls = (headers) => {
  return Object.entries(headers).map(
    ([key, value]) => createChain("header", wrapInDoubleQuotes(key), wrapInDoubleQuotes(value))
  );
};
const createBodyCall = (postData) => {
  if (!postData) {
    return null;
  }
  const { mimeType, text, params } = postData;
  switch (mimeType) {
    case "application/json": {
      const formattedJson = formatJson(text);
      return createChain("json", `&serde_json::json!(${formattedJson})`);
    }
    case "application/x-www-form-urlencoded": {
      const formData = params?.map((param) => `(${wrapInDoubleQuotes(param.name)}, ${wrapInDoubleQuotes(param.value || "")})`).join(", ") || "";
      return createChain("form", `&[${formData}]`);
    }
    case "multipart/form-data": {
      const formParts = params?.map(createMultipartPart).join("\n") || "";
      const multipartBlock = [
        ".multipart({",
        indent(2, "let mut form = reqwest::multipart::Form::new();"),
        formParts,
        indent(3, "form"),
        indent(2, "})")
      ].join("\n");
      return indent(1, multipartBlock);
    }
    default:
      return createChain("body", wrapInDoubleQuotes(text || ""));
  }
};
const buildRustCode = (url, method, chainedCalls) => {
  const code = ["let client = reqwest::Client::new();", ""];
  if (chainedCalls.length > 0) {
    code.push("let request = client");
    code.push(indent(1, `.${method.toLowerCase()}(${wrapInDoubleQuotes(url)})`));
    code.push(...chainedCalls);
  } else {
    code.push(`let request = client.${method.toLowerCase()}(${wrapInDoubleQuotes(url)})`);
  }
  const lastPart = code[code.length - 1];
  code[code.length - 1] = lastPart + ";";
  code.push("");
  code.push("let response = request.send().await?;");
  return code.join("\n");
};
export {
  rustReqwest
};
//# sourceMappingURL=reqwest.js.map
