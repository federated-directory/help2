const p = (t) => new Promise((r, n) => {
  if (t.flow.type === "clientCredentials" || t.flow.type === "password")
    u(t).then(r).catch(n);
  else {
    const e = t.flow.selectedScopes.join(" "), a = (Math.random() + 1).toString(36).substring(7), o = new URL(t.flow.authorizationUrl);
    t.flow.type === "implicit" ? o.searchParams.set("response_type", "token") : t.flow.type === "authorizationCode" && o.searchParams.set("response_type", "code"), o.searchParams.set("client_id", t.clientId), o.searchParams.set("redirect_uri", t.flow.redirectUri), o.searchParams.set("scope", e), o.searchParams.set("state", a);
    const i = window.open(o, "openAuth2Window", "left=100,top=100,width=800,height=600");
    if (i) {
      const d = setInterval(function() {
        var f;
        let s = null, c = null;
        try {
          const l = new URL(i.location.href).searchParams;
          s = l.get("access_token"), c = l.get("code");
        } catch {
        }
        if (i.closed || s || c)
          if (clearInterval(d), i.close(), s) {
            const l = (f = i.location.href.match(/state=([^&]*)/)) == null ? void 0 : f[1];
            s && l === a && r(s);
          } else c ? u(t, c).then(r).catch(n) : (clearInterval(d), n(
            new Error("Window was closed without granting authorization")
          ));
      }, 200);
    }
  }
}), u = async (t, r) => {
  if (!("clientSecret" in t.flow))
    throw new Error(
      "Authorize Servers only works for Client Credentials or Authorization Code flow"
    );
  if (!t.flow) throw new Error("OAuth2 flow was not defined");
  const n = t.flow.selectedScopes.join(" "), e = new URLSearchParams();
  e.set("client_id", t.clientId), e.set("scope", n), t.flow.clientSecret && e.set("client_secret", t.flow.clientSecret), "redirectUri" in t.flow && e.set("redirect_uri", t.flow.redirectUri), r && (e.set("code", r), e.set("grant_type", "authorization_code")), "secondValue" in t.flow ? (e.set("grant_type", "password"), e.set("username", t.flow.value), e.set("password", t.flow.secondValue)) : e.set("grant_type", "client_credentials");
  try {
    const a = {
      "Content-Type": "application/x-www-form-urlencoded"
    };
    t.clientId && t.flow.clientSecret && (a.Authorization = `Basic ${btoa(`${t.clientId}:${t.flow.clientSecret}`)}`);
    const o = await fetch(t.flow.tokenUrl, {
      method: "POST",
      headers: a,
      body: e
    }), { access_token: w } = await o.json();
    return w;
  } catch {
    throw new Error(
      "Failed to get an access token. Please check your credentials."
    );
  }
};
export {
  p as authorizeOauth2,
  u as authorizeServers
};
