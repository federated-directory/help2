{
  "version": 3,
  "sources": ["../../src/mutator-record/handlers.ts"],
  "sourcesContent": ["import { debounce } from '@scalar/helpers/general/debounce'\nimport { safeLocalStorage } from '@scalar/helpers/object/local-storage'\nimport { stringify } from 'flatted'\n\nimport { Mutation } from '../mutator-record/mutations'\nimport type { Path, PathValue } from '../nested'\nimport { LS_CONFIG } from './local-storage'\n\nconst MAX_MUTATION_RECORDS = 500\n\n/** Generate mutation handlers for a given record of objects  */\nexport function mutationFactory<T extends Record<string, any>>(\n  entityMap: Partial<Record<string, T>>,\n  mutationMap: Partial<Record<string, Mutation<T>>>,\n  localStorageKey?: string | false,\n  maxNumberRecords: number = MAX_MUTATION_RECORDS,\n) {\n  const { execute } = debounce({ delay: LS_CONFIG.DEBOUNCE_MS, maxWait: LS_CONFIG.MAX_WAIT_MS })\n\n  function getMutator(uid: T['uid']) {\n    const mutator = mutationMap[uid]\n\n    if (!mutator) {\n      console.warn(`Missing ${entityMap[uid] ? 'mutator' : 'object'} for uid: ${uid}`)\n    }\n\n    return mutator ?? null\n  }\n\n  /** Triggers on any changes so we can save to localStorage */\n  const onChange = localStorageKey\n    ? () => execute(localStorageKey, () => safeLocalStorage().setItem(localStorageKey, stringify(entityMap)))\n    : () => null\n\n  return {\n    /** Adds a new item to the record of tracked items and creates a new mutation tracking instance */\n    add: (item: T) => {\n      entityMap[item.uid] = item\n      mutationMap[item.uid] = new Mutation(item, maxNumberRecords)\n      onChange()\n    },\n    delete: (uid: T['uid'] | null | undefined) => {\n      if (!uid) {\n        console.warn('[@scalar/object-utils] No uid provided to delete')\n        return\n      }\n      delete entityMap[uid]\n      delete mutationMap[uid]\n      onChange()\n    },\n    /** Destructive, overwrites a record to a new item and creates a new mutation tracking instance */\n    set: (item: T) => {\n      entityMap[item.uid] = item\n      mutationMap[item.uid] = new Mutation(item, maxNumberRecords)\n      onChange()\n    },\n    /** Update a nested property and track the mutation */\n    edit: <P extends Path<T>>(uid: T['uid'] | null | undefined, path: P, value: PathValue<T, P>) => {\n      if (!uid) {\n        console.warn('[@scalar/object-utils] No uid provided to edit', path, value)\n        return\n      }\n      const mutator = getMutator(uid)\n      mutator?.mutate(path, value)\n      onChange()\n    },\n    /** Commit an untracked edit to the object (undo/redo will not work) */\n    untrackedEdit: <P extends Path<T>>(uid: T['uid'], path: P, value: PathValue<T, P>) => {\n      const mutator = getMutator(uid)\n      mutator?._unsavedMutate(path, value)\n      onChange()\n    },\n    /** Undo the last mutation */\n    undo: (uid: T['uid']) => {\n      const mutator = getMutator(uid)\n      mutator?.undo()\n      onChange()\n    },\n    /** Redo a mutation if available */\n    redo: (uid: T['uid']) => {\n      const mutator = getMutator(uid)\n      mutator?.redo()\n      onChange()\n    },\n    /** Destructive, clears the record */\n    reset: () => {\n      Object.keys(entityMap).forEach((uid) => {\n        delete entityMap[uid]\n        delete mutationMap[uid]\n      })\n      onChange()\n    },\n  }\n}\n\nexport type Mutators<T extends object> = ReturnType<typeof mutationFactory<T>>\n"],
  "mappings": "AAAA,SAAS,gBAAgB;AACzB,SAAS,wBAAwB;AACjC,SAAS,iBAAiB;AAE1B,SAAS,gBAAgB;AAEzB,SAAS,iBAAiB;AAE1B,MAAM,uBAAuB;AAGtB,SAAS,gBACd,WACA,aACA,iBACA,mBAA2B,sBAC3B;AACA,QAAM,EAAE,QAAQ,IAAI,SAAS,EAAE,OAAO,UAAU,aAAa,SAAS,UAAU,YAAY,CAAC;AAE7F,WAAS,WAAW,KAAe;AACjC,UAAM,UAAU,YAAY,GAAG;AAE/B,QAAI,CAAC,SAAS;AACZ,cAAQ,KAAK,WAAW,UAAU,GAAG,IAAI,YAAY,QAAQ,aAAa,GAAG,EAAE;AAAA,IACjF;AAEA,WAAO,WAAW;AAAA,EACpB;AAGA,QAAM,WAAW,kBACb,MAAM,QAAQ,iBAAiB,MAAM,iBAAiB,EAAE,QAAQ,iBAAiB,UAAU,SAAS,CAAC,CAAC,IACtG,MAAM;AAEV,SAAO;AAAA;AAAA,IAEL,KAAK,CAAC,SAAY;AAChB,gBAAU,KAAK,GAAG,IAAI;AACtB,kBAAY,KAAK,GAAG,IAAI,IAAI,SAAS,MAAM,gBAAgB;AAC3D,eAAS;AAAA,IACX;AAAA,IACA,QAAQ,CAAC,QAAqC;AAC5C,UAAI,CAAC,KAAK;AACR,gBAAQ,KAAK,kDAAkD;AAC/D;AAAA,MACF;AACA,aAAO,UAAU,GAAG;AACpB,aAAO,YAAY,GAAG;AACtB,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,KAAK,CAAC,SAAY;AAChB,gBAAU,KAAK,GAAG,IAAI;AACtB,kBAAY,KAAK,GAAG,IAAI,IAAI,SAAS,MAAM,gBAAgB;AAC3D,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,MAAM,CAAoB,KAAkC,MAAS,UAA2B;AAC9F,UAAI,CAAC,KAAK;AACR,gBAAQ,KAAK,kDAAkD,MAAM,KAAK;AAC1E;AAAA,MACF;AACA,YAAM,UAAU,WAAW,GAAG;AAC9B,eAAS,OAAO,MAAM,KAAK;AAC3B,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,eAAe,CAAoB,KAAe,MAAS,UAA2B;AACpF,YAAM,UAAU,WAAW,GAAG;AAC9B,eAAS,eAAe,MAAM,KAAK;AACnC,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,MAAM,CAAC,QAAkB;AACvB,YAAM,UAAU,WAAW,GAAG;AAC9B,eAAS,KAAK;AACd,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,MAAM,CAAC,QAAkB;AACvB,YAAM,UAAU,WAAW,GAAG;AAC9B,eAAS,KAAK;AACd,eAAS;AAAA,IACX;AAAA;AAAA,IAEA,OAAO,MAAM;AACX,aAAO,KAAK,SAAS,EAAE,QAAQ,CAAC,QAAQ;AACtC,eAAO,UAAU,GAAG;AACpB,eAAO,YAAY,GAAG;AAAA,MACxB,CAAC;AACD,eAAS;AAAA,IACX;AAAA,EACF;AACF;",
  "names": []
}
